<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema Institucional</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #eee; }
    button { margin-left: 5px; }
    #panel { margin-bottom: 15px; }
  </style>
</head>
<body>

<h2>Panel de Consulta</h2>

<div id="panel">
  <strong>Usuario:</strong> <span id="usuario"></span>

  <button onclick="mostrarSelector()">Cambiar módulo</button>
  <button onclick="cerrarSesion()">Cerrar sesión</button>
</div>

<div id="selector">
  <h3>Seleccione módulo</h3>
  <button onclick="cargarModulo('notas')">Notas</button>
  <button onclick="cargarModulo('alcoholemia')">Alcoholemia</button>
</div>

<div id="busqueda" style="display:none;">
  <h3 id="titulo"></h3>

  <label>Año</label>
  <input type="number" id="anio">

  <label>Mes</label>
  <input type="number" id="mes" min="1" max="12">

  <label>Número</label>
  <input type="number" id="numero">

  <button onclick="buscar()">Buscar</button>
  <button onclick="limpiar()">Limpiar</button>

  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ================= SUPABASE ================= */

const supabase = window.supabase.createClient(
  "https://dqopyfoshzmsdgrirfku.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxb3B5Zm9zaHptc2RncmlyZmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNjc1ODIsImV4cCI6MjA4NDg0MzU4Mn0.uMDoJVkCf5k_j4BEroMFp7oYCSFX0TDi1zV-nZIwIeY"
);

let moduloActual = "";

supabase.auth.getUser().then(({ data }) => {
  if (!data.user) location.href = "login.html";
  document.getElementById("usuario").textContent = data.user.email;
});

/* ================= UI ================= */

function mostrarSelector() {
  document.getElementById("selector").style.display = "block";
  document.getElementById("busqueda").style.display = "none";
}

function cargarModulo(modulo) {
  moduloActual = modulo;
  document.getElementById("selector").style.display = "none";
  document.getElementById("busqueda").style.display = "block";

  document.getElementById("titulo").textContent =
    modulo === "notas" ? "Consulta Notas" : "Consulta Alcoholemia";

  construirEncabezados();
}

function limpiar() {
  document.getElementById("anio").value = "";
  document.getElementById("mes").value = "";
  document.getElementById("numero").value = "";
  document.getElementById("tbody").innerHTML = "";
}

async function cerrarSesion() {
  await supabase.auth.signOut();
  location.href = "login.html";
}

/* ================= TABLAS ================= */

function construirEncabezados() {
  const thead = document.getElementById("thead");

  if (moduloActual === "notas") {
    thead.innerHTML = `
      <tr>
        <th>Delegación</th>
        <th>Ingreso</th>
        <th>Nota</th>
        <th>Fecha</th>
        <th>Contacto</th>
        <th>Teléfono</th>
        <th>Observación</th>
      </tr>`;
  } else {
    thead.innerHTML = `
      <tr>
        <th>Fecha</th>
        <th>Conductor</th>
        <th>Género</th>
        <th>Licencia</th>
        <th>Grados</th>
        <th>Lugar</th>
        <th>Agente</th>
        <th>No. Hoja</th>
        <th>Delegación</th>
      </tr>`;
  }
}

/* ================= BUSQUEDA ================= */

async function buscar() {
  let query;

  const anio = document.getElementById("anio").value;
  const mes = document.getElementById("mes").value;
  const numero = document.getElementById("numero").value;

  if (moduloActual === "notas") {
    query = supabase.from("notas").select("*");

    if (numero) query = query.eq("nota", numero);
  }

  if (moduloActual === "alcoholemia") {
    query = supabase.from("alcoholemia").select("*");

    if (numero) query = query.eq("numero_de_hoja", Number(numero));
  }

  if (anio && mes) {
    const inicio = `${anio}-${String(mes).padStart(2, "0")}-01`;
    const fin = `${anio}-${String(mes).padStart(2, "0")}-31`;
    query = query.gte("fecha", inicio).lte("fecha", fin);
  }

  const { data, error } = await query;

  if (error) {
    alert(error.message);
    return;
  }

  renderizar(data);
}

/* ================= RENDER ================= */

function renderizar(data) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach(r => {
    if (moduloActual === "notas") {
      tbody.innerHTML += `
        <tr>
          <td>${r.delegacion}</td>
          <td>${r.ingreso}</td>
          <td>${r.nota}</td>
          <td>${r.fecha}</td>
          <td>${r.contacto}</td>
          <td>${r.telefono || ""}</td>
          <td>${r.observacion || ""}</td>
        </tr>`;
    }

    if (moduloActual === "alcoholemia") {
      tbody.innerHTML += `
        <tr>
          <td>${r.fecha}</td>
          <td>${r.conductor}</td>
          <td>${r.genero}</td>
          <td>${r.licencia}</td>
          <td>${r.grados}</td>
          <td>${r.lugar}</td>
          <td>${r.agente_pmt_a_cargo}</td>
          <td>${r.numero_de_hoja}</td>
          <td>${r.delegacion}</td>
        </tr>`;
    }
  });
}
</script>

</body>
</html>
