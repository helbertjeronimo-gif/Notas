<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hojas de trabajo</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

<style>
body { background:#f4f6f8; }
.card { margin-top:30px; }
.hidden { display:none; }
</style>
</head>

<body>

<div class="container">

<!-- LOGIN -->
<div id="login" class="card p-4">
<h4>Ingreso al sistema</h4>

<input id="email" type="email" class="form-control mb-2" placeholder="Correo">
<input id="password" type="password" class="form-control mb-3" placeholder="Contraseña">

<button class="btn btn-primary" onclick="login()">Ingresar</button>
<p id="msg" class="text-danger mt-2"></p>
</div>

<!-- SELECTOR -->
<div id="selector" class="card p-4 hidden">
<div class="d-flex justify-content-between mb-3">
<div>Usuario: <strong id="usuario"></strong></div>
<button class="btn btn-outline-danger btn-sm" onclick="logout()">Cerrar sesión</button>
</div>

<h5>Seleccione módulo</h5>

<div class="d-flex gap-3 mt-3">
<button class="btn btn-success" onclick="abrirNotas()">Notas</button>
<button class="btn btn-warning" onclick="abrirAlcohol()">Alcoholemia</button>
</div>
</div>

<!-- PANEL -->
<div id="panel" class="card p-4 hidden">

<div class="d-flex justify-content-between mb-3">
<h5 id="titulo"></h5>
<div>
<button class="btn btn-secondary btn-sm" onclick="volver()">Volver</button>
<button class="btn btn-outline-danger btn-sm" onclick="logout()">Cerrar sesión</button>
</div>
</div>

<div id="filtros" class="row g-2 mb-3"></div>

<div class="mb-2">
<button class="btn btn-success" onclick="buscar()">Buscar</button>
<button class="btn btn-secondary" onclick="limpiar()">Limpiar</button>
<button class="btn btn-outline-success" onclick="exportar()">Exportar Excel</button>
</div>

<div id="tabla"></div>

</div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://dqopyfoshzmsdgrirfku.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxb3B5Zm9zaHptc2RncmlyZmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNjc1ODIsImV4cCI6MjA4NDg0MzU4Mn0.uMDoJVkCf5k_j4BEroMFp7oYCSFX0TDi1zV-nZIwIeY"
);

let tabla;
let modulo = "";

/* ---------- SESIÓN ---------- */

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) {
    msg.textContent = error.message;
    return;
  }

  const { data } = await supabase.auth.getUser();
  usuario.textContent = data.user.email;

  loginDiv(false);
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

function loginDiv(ok) {
  login.classList.toggle("hidden", ok);
  selector.classList.toggle("hidden", !ok);
}

supabase.auth.getUser().then(({ data }) => {
  if (data.user) {
    usuario.textContent = data.user.email;
    loginDiv(true);
  }
});

/* ---------- NAVEGACIÓN ---------- */

function abrirNotas() {
  modulo = "notas";
  titulo.textContent = "Consulta de Notas";
  crearFiltrosNotas();
  crearTablaNotas();
  mostrarPanel();
}

function abrirAlcohol() {
  modulo = "alcoholemia";
  titulo.textContent = "Consulta de Alcoholemia";
  crearFiltrosAlcohol();
  crearTablaAlcohol();
  mostrarPanel();
}

function volver() {
  panel.classList.add("hidden");
  selector.classList.remove("hidden");
}

function mostrarPanel() {
  selector.classList.add("hidden");
  panel.classList.remove("hidden");
}

/* ---------- FILTROS ---------- */

function crearFiltrosNotas() {
  filtros.innerHTML = `
  <div class="col-md-2"><input id="anio" class="form-control" placeholder="Año"></div>
  <div class="col-md-2"><input id="mes" class="form-control" placeholder="Mes"></div>
  <div class="col-md-3"><input id="nota" class="form-control" placeholder="Número de nota"></div>`;
}

function crearFiltrosAlcohol() {
  filtros.innerHTML = `
  <div class="col-md-3"><input id="anio" class="form-control" placeholder="Año"></div>
  <div class="col-md-3"><input id="mes" class="form-control" placeholder="Mes"></div>
  <div class="col-md-3"><input id="hoja" class="form-control" placeholder="Número de hoja"></div>`;
}

/* ---------- TABLAS ---------- */

function crearTablaNotas() {
  tabla = new Tabulator("#tabla", {
    height:"450px",
    layout:"fitDataStretch",
    columns:[
      {title:"Delegación", field:"delegacion"},
      {title:"Ingreso", field:"ingreso_no"},
      {title:"Nota", field:"nota_no"},
      {title:"Fecha", field:"fecha_actividad", formatter:formatoFecha},
      {title:"Contacto", field:"contacto"},
      {title:"Teléfono", field:"telefono"},
      {title:"Solicitud", field:"solicitud"},
      {title:"Encuesta", field:"encuesta"},
      {title:"Llegó a tiempo", field:"llego_a_tiempo"},
      {title:"Observación", field:"nota"}
    ]
  });
}

function crearTablaAlcohol() {
  tabla = new Tabulator("#tabla", {
    height:"450px",
    layout:"fitDataStretch",
    columns:[
      {title:"Fecha", field:"fecha", formatter:formatoFecha},
      {title:"Conductor", field:"conductor"},
      {title:"Género", field:"genero"},
      {title:"Licencia", field:"licencia"},
      {title:"Grados", field:"grados"},
      {title:"Lugar", field:"lugar"},
      {title:"Agente", field:"agente_pmt_a_cargo"},
      {title:"Hoja", field:"numero_de_hoja"},
      {title:"Delegación", field:"delegacion"}
    ]
  });
}

/* ---------- CONSULTAS ---------- */

async function buscar() {
  let q = supabase.from(modulo).select("*");

  const anio = document.getElementById("anio")?.value;
  const mes = document.getElementById("mes")?.value;

  if (modulo === "notas" && document.getElementById("nota")?.value) {
    q = q.eq("nota_no", document.getElementById("nota").value);
  }

  if (modulo === "alcoholemia" && document.getElementById("hoja")?.value) {
    q = q.eq("numero_de_hoja", document.getElementById("hoja").value);
  }

  if (anio && mes) {
    const m = mes.padStart(2,"0");
    q = q.gte("fecha", `${anio}-${m}-01`)
         .lt("fecha", `${anio}-${parseInt(m)+1}-01`);
  }

  const { data, error } = await q;

  if (error) alert(error.message);
  else tabla.setData(data);
}

async function limpiar() {
  const { data } = await supabase.from(modulo).select("*");
  tabla.setData(data);
}

function exportar() {
  tabla.download("xlsx", `${modulo}.xlsx`);
}

function formatoFecha(cell) {
  const v = cell.getValue();
  if (!v) return "";
  const p = v.split("-");
  return `${p[2]}/${p[1]}/${p[0]}`;
}
</script>

</body>
</html>
