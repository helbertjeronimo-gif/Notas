<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Visor</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

<style>
body { background:#f5f5f5; }
.card { margin-top:40px; cursor:pointer; }
.card-select:hover { background:#f0f8ff; }
</style>
</head>

<body>

<div class="container">

<!-- LOGIN -->
<div id="login" class="card p-4">
<h4 class="mb-3">Ingreso al sistema</h4>

<input id="email" type="email" class="form-control mb-3" placeholder="Correo">
<input id="password" type="password" class="form-control mb-3" placeholder="Contrase帽a">

<button id="btnLogin" class="btn btn-primary">Ingresar</button>
<p id="msg" class="text-danger mt-2"></p>
</div>

<!-- SELECCIN -->
<div id="selector" class="row" style="display:none;">
<div class="col-md-6">
<div class="card p-4 card-select text-center" onclick="seleccionarModulo('notas')">
<h5> Visor de Notas</h5>
<p>Consulta por fecha o n煤mero de nota</p>
</div>
</div>

<div class="col-md-6">
<div class="card p-4 card-select text-center" onclick="seleccionarModulo('alcoholemia')">
<h5> Visor de Alcoholemia</h5>
<p>Consulta registros de alcoholemia</p>
</div>
</div>
</div>

<!-- PANEL -->
<div id="panel" class="card p-4" style="display:none;">

<div class="d-flex justify-content-between align-items-center mb-3">
<div>Usuario: <strong id="usuario"></strong></div>
<button id="btnSalir" class="btn btn-outline-danger btn-sm">Cerrar sesi贸n</button>
</div>

<div class="row g-2 mb-3">
<div class="col-md-2">
<input id="anio" type="number" class="form-control" placeholder="A帽o">
</div>
<div class="col-md-2">
<input id="mes" type="number" min="1" max="12" class="form-control" placeholder="Mes">
</div>
<div class="col-md-3">
<input id="nota" class="form-control" placeholder="N煤mero">
</div>
<div class="col-md-5 text-end">
<button id="btnBuscar" class="btn btn-success">Buscar</button>
<button id="btnLimpiar" class="btn btn-secondary">Limpiar</button>
<button id="btnExcel" class="btn btn-outline-success">Exportar Excel</button>
</div>
</div>

<div id="tabla"></div>

</div>
</div>

<script>
const client = supabase.createClient(
  "https://dqopyfoshzmsdgrirfku.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxb3B5Zm9zaHptc2RncmlyZmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNjc1ODIsImV4cCI6MjA4NDg0MzU4Mn0.uMDoJVkCf5k_j4BEroMFp7oYCSFX0TDi1zV-nZIwIeY"
);

let tabla;
let modoActual = "";

document.getElementById("btnLogin").addEventListener("click", ingresar);
document.getElementById("btnBuscar").addEventListener("click", cargar);
document.getElementById("btnLimpiar").addEventListener("click", limpiar);
document.getElementById("btnExcel").addEventListener("click", exportarExcel);
document.getElementById("btnSalir").addEventListener("click", salir);

async function ingresar() {
  const { error } = await client.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });

  if (error) {
    msg.textContent = error.message;
    return;
  }

  const { data } = await client.auth.getUser();
  usuario.textContent = data.user.email.split("@")[0];

  login.style.display = "none";
  selector.style.display = "flex";
}

function seleccionarModulo(modo) {
  modoActual = modo;
  selector.style.display = "none";
  panel.style.display = "block";
  iniciarTabla();
  limpiar();
}

function iniciarTabla() {
  if (tabla) tabla.destroy();

  if (modoActual === "notas") {
    tabla = new Tabulator("#tabla", {
      layout:"fitDataStretch",
      height:"500px",
      initialSort:[{ column:"fecha_actividad", dir:"asc" }],
      columns:[
        { title:"Delegaci贸n", field:"delegacion" },
        { title:"Ingreso", field:"ingreso_no" },
        { title:"Nota", field:"nota_no" },
        { title:"Fecha", field:"fecha_actividad",
          formatter(cell){
            const v = cell.getValue().split("-");
            return `${v[2]}/${v[1]}/${v[0]}`;
          }
        },
        { title:"Contacto", field:"contacto" },
        { title:"Tel茅fono", field:"telefono" },
        { title:"Observaci贸n", field:"nota" }
      ]
    });
  }

  if (modoActual === "alcoholemia") {
    tabla = new Tabulator("#tabla", {
      layout:"fitDataStretch",
      height:"500px",
      initialSort:[{ column:"fecha_actividad", dir:"asc" }],
      columns:[
        { title:"Fecha", field:"fecha_actividad",
          formatter(cell){
            const v = cell.getValue().split("-");
            return `${v[2]}/${v[1]}/${v[0]}`;
          }
        },
        { title:"Conductor", field:"conductor" },
        { title:"G茅nero", field:"genero" },
        { title:"Licencia", field:"licencia" },
        { title:"Grados", field:"grados" },
        { title:"Lugar", field:"lugar" },
        { title:"Agente", field:"agente" },
        { title:"Hoja", field:"hoja" },
        { title:"Delegaci贸n", field:"delegacion" }
      ]
    });
  }
}

async function cargar() {
  let tablaDB = modoActual === "notas" ? "notas" : "alcoholemia";
  let consulta = client.from(tablaDB).select("*");

  if (anio.value && mes.value) {
    const m = mes.value.padStart(2,"0");
    consulta = consulta
      .gte("fecha_actividad", `${anio.value}-${m}-01`)
      .lt("fecha_actividad", `${anio.value}-${parseInt(m)+1}-01`);
  }

  const { data } = await consulta.order("fecha_actividad",{ ascending:true });
  tabla.setData(data);
}

async function limpiar() {
  anio.value = "";
  mes.value = "";
  nota.value = "";

  const tablaDB = modoActual === "notas" ? "notas" : "alcoholemia";
  const { data } = await client.from(tablaDB).select("*").order("fecha_actividad",{ ascending:true });
  tabla.setData(data);
}

function exportarExcel() {
  const nombre = modoActual === "notas" ? "notas.xlsx" : "alcoholemia.xlsx";
  tabla.download("xlsx", nombre, { sheetName:"Datos" });
}

async function salir() {
  await client.auth.signOut();
  location.reload();
}
</script>

</body>
</html>
